# 文本分割可视化使用指南

本文档说明如何在网页上查看文本分割的可视化结果。

## 快速开始

### 1. 启动服务

首先确保后端和前端都在运行：

```bash
# 终端1: 启动后端服务器
cd /home/supercomputing/studys/fairytales_resarch
conda run -n nlp python -m uvicorn backend.main:app --host 127.0.0.1 --port 8000

# 终端2: 启动前端服务器
cd story_visualization
npm run dev
```

前端通常运行在 `http://localhost:5174`，后端在 `http://localhost:8000`。

### 2. 打开页面

1. 在浏览器中打开前端地址（通常是 `http://localhost:5174`）
2. 在顶部导航栏点击 **"Segmentation"** 链接
3. 或者直接访问 `http://localhost:5174/segmentation`

## 查看可视化步骤

### 步骤 1: 打开文件夹

1. 在左侧边栏（Story Browser）点击 **"Open Folder"** 按钮
2. 选择一个包含 `texts` 子文件夹的文件夹（例如：`datasets/ChineseTales/`）
3. 系统会自动加载 `texts/` 文件夹中的所有 `.txt` 故事文件

### 步骤 2: 选择故事

在左侧边栏的故事列表中选择一个故事。故事文本会自动加载到页面中。

### 步骤 3: 配置参数（可选）

在 "Algorithm Parameters" 部分：

- **Algorithm**: 选择算法类型
  - `Magnetic Clustering`: 磁力聚类算法
  - `GraphSegSM`: 图分割算法
- **Context Window**: 上下文窗口大小（1-5）
- 根据选择的算法调整相应参数

### 步骤 4: 输入参考边界（可选，用于评估）

如果要对比预测结果与真实边界：

1. 在 "Ground Truth" 部分
2. 输入参考边界索引，用逗号分隔，例如：`2, 5, 8, 12`
3. 注意：边界索引 `i` 表示句子 `i` 和 `i+1` 之间的边界

### 步骤 5: 执行分割

1. 点击 **"Segment Text"** 按钮
2. 等待分割完成（状态显示为 "Segmenting..."）

### 步骤 6: 查看结果

分割完成后，页面会显示：

#### 1. 分割结果摘要
- **Boundary Score**: 如果有参考边界，显示评估分数
- **Algorithm**: 使用的算法
- **Segments**: 分割的段数
- **Boundaries**: 预测的边界位置

#### 2. 可视化图表

根据算法和数据，会自动显示以下可视化：

##### ✅ 相似度矩阵热力图（所有算法）

- **位置**: 结果页面下方 "Visualization" 部分
- **说明**: 
  - 显示所有句子之间的余弦相似度
  - 颜色从深到浅表示相似度从低到高
  - 如果提供了参考边界，会用青色虚线标记
- **用途**: 了解文本的语义相似性分布

##### ✅ 磁力信号分析图（仅 Magnetic Clustering）

- **位置**: 在相似度矩阵下方
- **说明**:
  - **浅灰色线**: 原始磁力值 (`raw_forces`)
  - **紫色粗线**: 平滑后的信号 (`smoothed_forces`)
  - **红色虚线**: 预测的边界位置
  - **蓝色填充**: 正向磁力区域（吸引）
  - **红色填充**: 负向磁力区域（排斥）
- **用途**: 理解磁力聚类算法如何找到边界

##### ✅ 分割比较条形图（需要参考边界）

- **位置**: 在磁力信号图（或相似度矩阵）下方
- **说明**:
  - **上半部分（Prediction）**: 预测的边界
    - 绿色：完全匹配
    - 橙色：接近匹配（容差范围内）
    - 红色：错误预测
  - **下半部分（Ground Truth）**: 真实边界（绿色）
- **用途**: 直观对比预测结果与真实分割

## 可视化示例

### 示例 1: 基本分割（无参考边界）

1. 选择故事 → 2. 点击 "Segment Text" → 3. 查看结果

**会显示：**
- ✅ 相似度矩阵热力图
- ✅ 磁力信号分析图（如果使用 Magnetic 算法）
- ❌ 分割比较图（需要参考边界）

### 示例 2: 带评估的分割

1. 选择故事
2. 在 "Reference Boundaries" 输入：`5, 10, 15, 20`
3. 点击 "Segment Text"
4. 查看结果

**会显示：**
- ✅ 相似度矩阵热力图（带参考边界标记）
- ✅ 磁力信号分析图（如果使用 Magnetic 算法）
- ✅ 分割比较条形图（对比预测和真实）

## 可视化说明

### 相似度矩阵热力图

```
┌─────────────────────────────────┐
│  Cosine Similarity Matrix       │
│                                 │
│  [热力图矩阵]                   │
│  ↑                              │
│  Sentence Index                 │
│                                 │
│  ←───────────────→              │
│   Sentence Index                │
│                                 │
│  ──── 参考边界（青色虚线）      │
└─────────────────────────────────┘
```

**图例说明：**
- 深色 = 低相似度
- 浅色 = 高相似度
- 青色虚线 = 参考边界（如果提供）

### 磁力信号分析图

```
┌─────────────────────────────────┐
│  Magnetic Signal Analysis       │
│                                 │
│  ↑                              │
│  Magnetization (b_i)            │
│  │                              │
│  │    ●─────●                   │
│  │   ╱       ╲                  │
│  │  ●         ●                 │
│  │             ╲                │
│  │──────────────●─────●         │
│  │                ╲   ╲         │
│  │                 ●   ●        │
│  └─────────────────────────────→│
│       Sentence Gap Index         │
│                                 │
│  ━━━ 原始信号（浅灰）            │
│  ─── 平滑信号（紫色）            │
│  ┊ 预测边界（红色虚线）          │
└─────────────────────────────────┘
```

**说明：**
- 信号从正变负或从负变正的位置通常是边界
- 红色虚线标记算法找到的边界

### 分割比较条形图

```
┌─────────────────────────────────┐
│  Segmentation Comparison        │
│                                 │
│  Prediction:                    │
│  │ │  │   │ │                  │
│  │ │  │   │ │                  │
│  ───────────────────────────────│
│  Ground Truth:                  │
│  │ │  │   │ │                  │
│  │ │  │   │ │                  │
│  └─────────────────────────────→│
│      Sentence Index             │
│                                 │
│  █ 匹配    ▓ 接近    ▒ 错误     │
└─────────────────────────────────┘
```

## 常见问题

### Q: 可视化不显示？

**检查：**
1. 后端是否正常运行（检查 `http://localhost:8000/health`）
2. 浏览器控制台是否有错误（F12 打开开发者工具）
3. 分割是否成功完成（查看 "Segmentation Results" 部分）

### Q: 相似度矩阵为空？

**原因：** 可能是：
- 文本太短（少于 2 个句子）
- 分割失败（查看错误信息）
- 后端返回的数据不完整

### Q: 磁力信号图不显示？

**原因：** 
- 只在使用 **Magnetic Clustering** 算法时显示
- 如果使用 GraphSegSM，不会显示此图

**解决方法：** 切换到 Magnetic Clustering 算法

### Q: 分割比较图不显示？

**原因：** 
- 需要提供参考边界（Ground Truth）

**解决方法：** 在 "Reference Boundaries" 字段输入边界索引

### Q: 图表显示太小？

**解决方法：**
- 放大浏览器窗口
- 图表会自动适应容器宽度
- 可以使用浏览器缩放功能（Ctrl/Cmd + 鼠标滚轮）

### Q: 如何导出可视化结果？

**当前版本：** 可视化仅在浏览器中显示

**未来计划：** 可以添加导出为 PNG/SVG 的功能

## 技术细节

### 可视化库

- **D3.js v7**: 用于绘制 SVG 图表
- **React**: 组件框架
- **响应式设计**: 图表自动适应容器大小

### 数据流

```
前端请求 → 后端 API (/api/text/segment)
         ↓
后端使用 VisualizableTextSegmenter
         ↓
收集可视化数据（相似度矩阵、磁力信号等）
         ↓
序列化为 JSON（numpy 数组转为列表）
         ↓
返回给前端
         ↓
React 组件使用 D3.js 渲染
```

### 性能说明

- **相似度矩阵**: 对于大型文档（>100 句子），可能渲染较慢
- **建议**: 对于超长文本，考虑分段处理

## 下一步

- [ ] 添加导出功能（PNG/SVG）
- [ ] 支持 GraphSegSM 的图结构可视化
- [ ] 交互式参数调整（实时更新）
- [ ] 批量处理多个故事

## 相关文档

- [文本分割算法文档](../../llm_model/text_segmentation/README.md)
- [可视化模块文档](../../llm_model/text_segmentation/README_VISUALIZATION.md)
- [后端 API 文档](../backend/README.md)
